<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Soldier Health – Live Dashboard</title>

<!-- Manifest for PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#151823">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0f1117; --card:#151823; --line:#262b3a; --fg:#e6e6e6; --muted:#9aa0b4; 
  --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#60a5fa;
}
*{box-sizing:border-box}
body{margin:0; background:var(--bg); color:var(--fg); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
header{padding:16px 20px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:12px; flex-wrap:wrap}
header h1{margin:0; font-size:18px; letter-spacing:.3px}
header .meta{color:var(--muted); font-size:13px}
.container{padding:20px; max-width:1200px; margin:0 auto}
.grid{display:grid; gap:16px}
.grid.kpi{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; display:flex; flex-direction:column; justify-content:center;}
.kpi .card h3{margin:0; font-size:12px; color:var(--muted); font-weight:600}
.kpi .val{margin-top:6px; font-size:22px; font-weight:700; display:flex; justify-content:space-between; align-items:center;}
.pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); font-size:12px}
.row{display:grid; gap:16px; grid-template-columns:1.2fr .8fr}
#map{height:340px; border-radius:12px}
.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
button,select{background:#1a2030; color:var(--fg); border:1px solid var(--line); border-radius:10px; padding:8px 10px; font:inherit; cursor:pointer}
button:hover{border-color:#3a4157}
.muted{color:var(--muted)}
footer{padding:14px 20px; border-top:1px solid var(--line); color:var(--muted); font-size:12px; text-align:center}
a{color:var(--accent); text-decoration:none}
a:hover{text-decoration:underline}
.statusText{font-size:14px;margin-left:6px;font-weight:500;}
.statusSafe{color:#22c55e;}
.statusDanger{color:#ef4444;}
</style>
</head>
<body>
<header>
  <h1>Soldier Health – Live Dashboard</h1>
  <span class="pill" id="statusPill">Status: <strong id="statusTxt">Connecting…</strong></span>
  <span class="meta" id="updatedMeta">Updated: —</span>
  <div class="controls" style="margin-left:auto">
    <label class="muted">Profile:
      <select id="profileSel">
        <option value="0" selected>Soldier 1</option>
        <option value="1">Soldier 2</option>
        <option value="2">Soldier 3</option>
      </select>
    </label>
    <label class="muted">History:
      <select id="historySel">
        <option value="30">Last 30</option>
        <option value="60" selected>Last 60</option>
        <option value="120">Last 120</option>
        <option value="300">Last 300</option>
      </select>
    </label>
    <button id="refreshBtn">Refresh</button>
    <button id="autoBtn">Auto: ON</button>
  </div>
</header>

<div class="container">
  <div class="grid kpi">
    <div class="card"><h3>BMP Temp (°C)</h3><div class="val" id="bmpVal">—</div></div>
    <div class="card"><h3>DHT Humidity (%)</h3><div class="val" id="dhtHumVal">—</div></div>
    <div class="card"><h3>Pressure (hPa)</h3><div class="val" id="pressVal">—</div></div>
    <div class="card"><h3>Altitude (m)</h3><div class="val" id="altVal">—</div></div>
    <div class="card"><h3>Heart Rate (BPM)</h3><div class="val" id="bpmVal">—</div></div>
    <div class="card"><h3>MQ135</h3><div class="val" id="mq135Val">—<span class="statusText" id="mq135Status"></span></div></div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="grid">
      <div class="card" style="height:250px;">
        <h3 style="margin:0 0 8px 0">Heart Rate (BPM)</h3>
        <canvas id="bpmChart" height="220"></canvas>
      </div>
      <div class="card" style="height:250px;">
        <h3 style="margin:0 0 8px 0">Temperature & Humidity</h3>
        <canvas id="thChart" height="220"></canvas>
      </div>
      <div class="card" style="height:250px;">
        <h3 style="margin:0 0 8px 0">Pressure (hPa)</h3>
        <canvas id="pChart" height="220"></canvas>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Location</h3>
      <div id="map"></div>
      <div class="muted" style="margin-top:8px">* Shows the last reported coordinate from ThingSpeak.</div>
    </div>
  </div>
</div>

<footer>
  Built for quick demos – reads JSON from ThingSpeak. Keep device update ≥15s to respect ThingSpeak limits.
</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const profiles = [
  { name: "Soldier 1", channelId: 3056722, readKey: "" },
  { name: "Soldier 2", channelId:  3056722, readKey: "" },
  { name: "Soldier 3", channelId: 3056722, readKey: "" }
];

let CHANNEL_ID = profiles[0].channelId;
let READ_API_KEY = profiles[0].readKey;

const AUTO_REFRESH_MS = 20000;

const statusTxt = document.getElementById("statusTxt");
const updatedMeta = document.getElementById("updatedMeta");
const historySel = document.getElementById("historySel");
const refreshBtn = document.getElementById("refreshBtn");
const autoBtn = document.getElementById("autoBtn");
const profileSel = document.getElementById("profileSel");

const vals = {
  bmp: document.getElementById("bmpVal"),
  hum: document.getElementById("dhtHumVal"),
  press: document.getElementById("pressVal"),
  alt: document.getElementById("altVal"),
  bpm: document.getElementById("bpmVal"),
  mq135: document.getElementById("mq135Val"),
  mq135Status: document.getElementById("mq135Status")
};

// Map
const map = L.map('map', { zoomControl: true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
let marker = null;
map.setView([20,78],4);

// Charts
let bpmChart, thChart, pChart;
function mkLineConfig(label, data, tension=0.3){
  return {
    type:'line', data, options:{
      responsive:true, maintainAspectRatio:false,
      scales:{x:{grid:{color:'#23283a'},ticks:{color:'#a5adcb'}},y:{grid:{color:'#23283a'},ticks:{color:'#a5adcb'}}},
      plugins:{legend:{labels:{color:'#c7cbe0'}},tooltip:{mode:'index',intersect:false}},
      elements:{line:{tension},point:{radius:0}}
    }
  };
}
function initCharts(){
  bpmChart=new Chart(document.getElementById('bpmChart').getContext('2d'),mkLineConfig('BPM',{labels:[],datasets:[{label:'BPM',data:[],borderColor:'#60a5fa'}]}));
  thChart=new Chart(document.getElementById('thChart').getContext('2d'),mkLineConfig('Temp/Hum',{labels:[],datasets:[
    {label:'BMP Temp',data:[],borderColor:'#22c55e'},
    {label:'Humidity',data:[],borderColor:'#f59e0b'}
  ]}));
  pChart=new Chart(document.getElementById('pChart').getContext('2d'),mkLineConfig('Pressure',{labels:[],datasets:[{label:'Pressure',data:[],borderColor:'#a78bfa'}]}));
}
function tsUrl(results){
  const base=`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json`;
  const q=new URLSearchParams({results:String(results)});
  if(READ_API_KEY) q.append('api_key',READ_API_KEY);
  return `${base}?${q.toString()}`;
}
function asNum(v,dp=2){const n=Number(v);return isFinite(n)?Number(n.toFixed(dp)):null;}
async function fetchData(results){statusTxt.textContent='Fetching…';const r=await fetch(tsUrl(results),{cache:'no-store'});return await r.json();}
function updateUI(j){
  const f=j.feeds;if(!f.length)return;const latest=f[f.length-1];
  vals.bmp.textContent=asNum(latest.field2,1)??'—';
  vals.hum.textContent=asNum(latest.field5,0)??'—';
  vals.press.textContent=asNum(latest.field3,1)??'—';
  vals.alt.textContent=asNum(latest.field4,1)??'—';
  vals.bpm.textContent=asNum(latest.field1,0)??'—';
  const gasVal=asNum(latest.field6,0);vals.mq135.textContent=gasVal??'—';
  vals.mq135Status.textContent=(gasVal<350?'Safe':'Gas Detected');
  vals.mq135Status.className='statusText '+(gasVal<350?'statusSafe':'statusDanger');
  updatedMeta.textContent=`Updated: ${new Date(latest.created_at).toLocaleString()}`;
  statusTxt.textContent='OK';
  const labels=f.map(x=>new Date(x.created_at).toLocaleTimeString());
  bpmChart.data.labels=labels;bpmChart.data.datasets[0].data=f.map(x=>asNum(x.field1));bpmChart.update('none');
  thChart.data.labels=labels;thChart.data.datasets[0].data=f.map(x=>asNum(x.field2));thChart.data.datasets[1].data=f.map(x=>asNum(x.field5));thChart.update('none');
  pChart.data.labels=labels;pChart.data.datasets[0].data=f.map(x=>asNum(x.field3));pChart.update('none');
  const lat=asNum(latest.field7),lng=asNum(latest.field8);
  if(lat&&lng){if(!marker)marker=L.marker([lat,lng]).addTo(map);else marker.setLatLng([lat,lng]);map.setView([lat,lng],13);}
}
let timer=null;
function setAuto(on){if(on){if(timer)clearInterval(timer);timer=setInterval(()=>reload(),20000);autoBtn.textContent='Auto: ON';}
else{if(timer)clearInterval(timer);timer=null;autoBtn.textContent='Auto: OFF';}}
async function reload(){try{const n=Number(historySel.value||60);const j=await fetchData(n);updateUI(j);}catch(e){console.error(e);statusTxt.textContent='Error';}}
refreshBtn.addEventListener('click',reload);
autoBtn.addEventListener('click',()=>setAuto(!timer));
historySel.addEventListener('change',reload);
profileSel.addEventListener('change',()=>{const i=Number(profileSel.value);CHANNEL_ID=profiles[i].channelId;READ_API_KEY=profiles[i].readKey;reload();});
initCharts();setAuto(true);reload();
</script>

<!-- PWA service worker registration -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>
</body>
</html>
